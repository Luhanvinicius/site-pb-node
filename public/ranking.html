<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking - Tactical</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/style.css">
    <style>
        .ranking-table {
            width: 100%;
        }
        .ranking-position {
            font-weight: bold;
        }
        .rank-img {
            width: 20px;
            height: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-crosshairs"></i> <strong>TACTICAL</strong>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/ranking">Ranking</a></li>
                    <li class="nav-item"><a class="nav-link" href="/clan">Clã</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-trophy"></i> Ranking Geral
            </div>
            <div class="card-body">
                <!-- Busca -->
                <div class="search mb-3" style="float: right;">
                    <form id="searchForm" method="get">
                        <input type="text" maxlength="15" class="form-control d-inline-block" style="width: 200px;" 
                               name="nick" id="nick" placeholder="Digite o nick">
                        <button type="submit" class="btn btn-warning">
                            <i class="fa fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                <div style="clear: both;"></div>

                <!-- Tabela de Ranking -->
                <div id="rankingTable">
                    <table class="table table-hover ranking-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nick</th>
                                <th>Rank</th>
                                <th>EXP</th>
                                <th>K/D</th>
                                <th>WIN/LOST</th>
                                <th>Escapes</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody">
                            <tr><td colspan="7" class="text-center">Carregando ranking...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                <nav aria-label="Page navigation" id="pagination">
                    <ul class="pagination justify-content-center"></ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        let totalPages = 1;

        // Função para carregar ranking
        async function loadRanking(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/ranking-full?pagina=${page}`);
                const data = await response.json();
                
                if (data.players && data.players.length > 0) {
                    currentPage = data.currentPage || page;
                    totalPages = data.totalPages || 1;
                    
                    const tbody = document.getElementById('rankingBody');
                    tbody.innerHTML = data.players.map((player, index) => {
                        const pos = player.position || (index + 1);
                        const posDisplay = pos <= 3 
                            ? `<img width="20" src="/imagens/ranking/${pos}.png" title="${pos}" onerror="this.style.display='none';"/> ${pos}º`
                            : `${pos}º`;
                        
                        const nick = player.player_name || '';
                        const nickDisplay = nick.length > 20 ? nick.substring(0, 20) + '...' : nick;
                        
                        return `
                            <tr>
                                <td class="ranking-position">${posDisplay}</td>
                                <td title="${nick}">${nickDisplay}</td>
                                <td><img src="/imagens/patentes/${player.rank || 0}.png" class="rank-img" alt="Rank ${player.rank}" onerror="this.src='/images/patentes/0.png';" /></td>
                                <td>${formatNumber(player.exp || 0)}</td>
                                <td>${player.kd || 0}%</td>
                                <td>${player.wl || 0}%</td>
                                <td>${formatNumber(player.escapes || 0)}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    updatePagination();
                } else {
                    document.getElementById('rankingBody').innerHTML = 
                        '<tr><td colspan="7" class="text-center">Nenhum jogador encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar ranking:', error);
                document.getElementById('rankingBody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar ranking</td></tr>';
            }
        }

        // Função de paginação
        function updatePagination() {
            const pagination = document.querySelector('#pagination ul');
            pagination.innerHTML = '';
            
            const maxLinks = 5;
            let start = Math.max(1, currentPage - maxLinks);
            let end = Math.min(totalPages, currentPage + maxLinks);
            
            // Previous
            pagination.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadRanking(${currentPage - 1}); return false;">Anterior</a>
                </li>
            `;
            
            // Números das páginas
            for (let i = start; i <= end; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadRanking(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // Next
            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadRanking(${currentPage + 1}); return false;">Próxima</a>
                </li>
            `;
        }

        // Buscar jogador
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nick = document.getElementById('nick').value.trim();
            
            if (!nick) {
                alert('Digite um nick para buscar');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/ranking/search?nick=${encodeURIComponent(nick)}`);
                const data = await response.json();
                
                if (response.ok) {
                    const tbody = document.getElementById('rankingBody');
                    const posDisplay = data.position <= 3 
                        ? `<img width="20" src="/imagens/ranking/${data.position}.png" title="${data.position}" onerror="this.style.display='none';"/> ${data.position}º`
                        : `${data.position}º`;
                    
                    tbody.innerHTML = `
                        <tr>
                            <td class="ranking-position">${posDisplay}</td>
                            <td>${data.player_name || ''}</td>
                            <td><img src="/imagens/patentes/${data.rank || 0}.png" class="rank-img" alt="Rank ${data.rank}" onerror="this.src='/images/patentes/0.png';" /></td>
                            <td>${formatNumber(data.exp || 0)}</td>
                            <td>${data.kd || 0}%</td>
                            <td>${data.wl || 0}%</td>
                            <td>${formatNumber(data.escapes || 0)}</td>
                        </tr>
                    `;
                    
                    document.getElementById('pagination').style.display = 'none';
                } else {
                    alert(data.error || 'Usuário não encontrado');
                    loadRanking(currentPage);
                }
            } catch (error) {
                console.error('Erro na busca:', error);
                alert('Erro ao buscar jogador');
            }
        });

        // Formatar números
        function formatNumber(num) {
            return new Intl.NumberFormat('pt-BR').format(num);
        }

        // Carregar ranking inicial
        const urlParams = new URLSearchParams(window.location.search);
        const pagina = parseInt(urlParams.get('pagina')) || 1;
        loadRanking(pagina);
    </script>
</body>
</html>

